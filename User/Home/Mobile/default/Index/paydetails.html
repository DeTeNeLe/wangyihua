<include file='index:head' />
<div class="tabs0">
	<ul>
		<li style="width:100%">
			<a href="#" class="current">
				<switch name="data.type">
					<case value="1">
						充值订单明细
					</case>
					<case value="2">
						注册会员付款订单[账户:{$data.regname}]
					</case>
					<default />
					充值订单明细
				</switch>
			</a>
		</li>
	</ul>
</div>
<div class="wrapper">
	<div class="content">
		<div class="tab1">
			<ul class="jilu">
				<li>
					<p class="jname">
						<span class="fl">
							编号：{$data.jmid}
						</span>
						<span class="fr">
							{$data.date}
						</span>
					</p>
					<dl class="kjname">
						<dt>
							<img class="lazy" src="{$data.fhpro_id|getFHProById=###,'image'}" data-original="http://yunsheng.oss-cn-beijing.aliyuncs.com/skin/images/product.jpg"
							/>
						</dt>
						<script>
							$(function() {
								$("img.lazy").lazyload();
							})
						</script>
						<dd>
							<h1>
								{$data.fhpro_id|getFHProById=###,'name'}
							</h1>
							<h2>
								会员账户：
								<span class="c1">
									{$data.regname|isnullthen=###}
								</span>
							</h2>
							<h2>
								订单类型：
								<span class="c1">
									<if condition="$data.type eq 1">
										账户充值
										<elseif condition="$data.type eq 2" />
										下线注册
										<else />
										停权
									</if>
								</span>
							</h2>
							<h2>
								金额：
								<span class="c1">
									￥{$data.money}元
								</span>
							</h2>
							<h2>
								状态：
								<span class="c1">
									<switch name="data.zt">
										<case value="0">
											待付款
										</case>
										<case value="1">
											已完成
										</case>
										<case value="2">
											已激活
										</case>
										<case value="3">
											已取消
										</case>
										<case value="4">
											待审核
										</case>
									</switch>
								</span>
							</h2>
						</dd>
					</dl>
					<p class="ok">
						<span class="note">
							入市须知：
							<input type="checkbox" value="1" name="payagreement" checked="checked"
							id="payagreement" style="width:30px;height:30px;" />
							已阅读并同意入市须知
						</span>
						<span class="fr">
							<a href="/readme_pay.html" target="_blank">
								查看协议
							</a>
						</span>
					</p>
				</li>
			</ul>
		</div>
	</div>
	<!-- S付款方式 -->
	<div class="fukuan">
		<switch name="data.payzt">
			<case value="0">
				<div class="tabs0">
					<ul>
						<li style="width:100%">
							<a href="#" class="current">
								选择一种方式完成付款流程
							</a>
						</li>
					</ul>
				</div>
				<div class="cm1 focus" id="div1" name="div2">
					<table width="100%" border="0" cellspacing="0" cellpadding="0" class=""
					id="balanceTable">
						<tr>
							<td width="30%">
								<label>
									<input name="bankPay" id="bankPay" type="checkbox" value="6" />
									微信支付
								</label>
							</td>
						</tr>
					</table>
				</div>
				<!-- 如果是保单中心会员 -->
				<if condition="$data.type eq '2'">
					<if condition="$userData.sfjl eq 1">
						<div class="cm1 focus" id="div2" name="div2">
							<table width="100%" border="0" cellspacing="0" cellpadding="0" class=""
							id="balanceTable">
								<tr>
									<td width="30%">
										<label>
											<input name="balancePay" id="balancePay" type="checkbox" value="2" />
											奖金支付
										</label>
									</td>
									<td>
										<label id="balanceTd1" class="">
										</label>
									</td>
									<td>
										<label id="balanceTd2" class="">
										</label>
									</td>
								</tr>
							</table>
						</div>
					</if>
				</if>
			</case>
			<case value="1|2|3|4">
			</case>
			<default />
		</switch>
	</div>
	<div>
		<h6>
		  <switch name="data.payzt">
			<case value="0">
			  <button style="#fff" class="btn btn-success" type="button" onclick="return pay();">
				<i class="icon-ok icon-white">
				</i>
				<span style="color:#fff">
					<a id="confirm" style="color: #ffffff;">立即付款</a>
				</span>
			  </button>
		    </case>
			<case value="1">
			  <button style="#fff" class="btn btn-success" type="button">
				<i class="icon-ok icon-white">
				</i>
				<span style="color:#fff">
					订单已完成
				</span>
			  </button>
			 </case>
		    <default />
		  </switch>
		</h6>
	</div>
	<!-- E付款方式 -->
</div>
<script>
	$(document).ready(function() {
		$("#bankTable").addClass("active");
		$("#balanceTable").removeClass("active");
		$("#div1").addClass("focus");
		$("#div2").removeClass("focus");
		$("input[name='bankPay']").attr("checked", 'true');
		$("input[name='balancePay']").removeAttr("checked");
		$("input[name='bankPay']").attr('disabled', 'disabled');
		$("input[name='balancePay']").removeAttr('disabled');

		$("#btn1").css({
			border: "2px solid #21AB69"
		});
		$("#btn2,#btn3,#btn4,#btn5,#btn6,#btn7,#btn8,#btn9,#btn10").css({
			border: "2px solid #ddd"
		});
		$("#btn1 .bankon").css({
			display: "block"
		});
		$("#btn2 .bankon,#btn3 .bankon,#btn4 .bankon,#btn5 .bankon,#btn6 .bankon,#btn7 .bankon,#btn8 .bankon,#btn9 .bankon, #btn10 .bankon").css({
			display: "none"
		});
		//$("#confirm").attr("href","/Home/Index/onlinepay/id/{$data.jmid}/"); 
		$("#confirm").attr("href", "/Home/Index/wxpay/id/{$data.jmid}");

		$("#confirm").attr("target", "_blank");

		$("#bankPay").change(function() {
			$("#bankTable").addClass("active");
			$("#balanceTable").removeClass();
			$("#div1").addClass("focus");
			$("#div2").removeClass("focus");
			$("input[name='bankPay']").attr("checked", 'true');
			$("input[name='balancePay']").removeAttr("checked");
			$("input[name='bankPay']").attr('disabled', 'disabled');
			$("input[name='balancePay']").removeAttr('disabled');

			$("#btn1").css({
				border: "2px solid #21AB69"
			});
			$("#btn2,#btn3,#btn4,#btn5,#btn6,#btn7,#btn8,#btn9,#btn10").css({
				border: "2px solid #ddd"
			});
			$("#confirm").attr("href", "/Home/Index/wxpay/id/{$data.jmid}/bank/1002");
			$("#confirm").attr("target", "_blank");
			//$("#confirm").attr("href","/Home/Index/onlinepay/id/{$data.jmid}/"); 
			//$("#confirm").attr("target","_blank");
			var balance = {$userData.freeztj};

			$("#balanceTd1").html("奖金余额：<strong><font color='red'>￥" + fmoney(balance, 2) + "</font></strong>");
			$("#balanceTd2").html('');

		});

		$("#balancePay").change(function() {
			$("#bankTable").removeClass("active");
			$("#balanceTable").addClass("active");
			$("#div1").removeClass("focus");
			$("#div2").addClass("focus");
			$("input[name='balancePay']").attr("checked", 'true');
			$("input[name='bankPay']").removeAttr("checked");
			$("input[name='balancePay']").attr('disabled', 'disabled');
			$("input[name='bankPay']").removeAttr('disabled');

			$("#btn1,#btn2,#btn3,#btn4,#btn5,#btn6,#btn7,#btn8,#btn9,#btn10,#btn11").css({
				border: "1px solid #ddd"
			});
			$("#bank1,#bank2,#bank3,#bank4,#bank5,#bank6,#bank7,#bank8,#bank9,#bank10,#bank11").attr('disabled', 'disabled');

			var balance = {$userData.freeztj};
			var amount = {$data.money};

			$("#balanceTd1").html("<strong><font color='red'>￥" + fmoney(balance, 2) + "</font> - <font color='green'>￥" + fmoney(amount, 2) + "</font></strong>");

			var diff = balance - amount;
			if (diff < 0) {
				$("#balanceTd2").html('<label class="error">余额不足!</label>');
				$("#confirm").removeAttr('onclick');
			}
			$("#confirm").removeAttr('href');
		});
	})
</script>
<script type="text/javascript">
	var registerAmount = {$data.money};
	artDialog.prompt = function(content, title, yes, value) {
		value = value || '';
		var input;

		return artDialog({
			id: 'Prompt',
			icon: 'question',
			fixed: true,
			title: title,
			lock: true,
			opacity: .1,
			content: ['<div style="margin-bottom:5px;font-size:12px">', content, '</div>', ].join(''),
			init: function() {
				// input = this.DOM.content.find('input')[0];
				// input.select();
				// input.focus();
			},
			ok: function(here) {
				return yes && yes.call(this, here);
			},
			cancel: true,
			okVal: '确定',
			cancelVal: '取消',
			title: '使用钱包余额付款'
		});
	};

	artDialog.tips = function(content, time) {
		return artDialog({
			id: 'Tips',
			title: false,
			cancel: false,
			fixed: true,
			lock: true,
			title: title

		}).content('<div style="padding: 0 1em;">' + content + '</div>').time(time || 1);
	};

	function pay() {

		if (!$("#payagreement").is(':checked')) {
			art.dialog({
				lock: true,
				opacity: 0.3,
				icon: 'error',
				content: ' 请阅读上述入市须知，如您认可并自愿承担风险，请打钩后再付款。！',
				ok: function() {},
				width: 300,
				cancel: false,
				okVal: '确定',
				cancelVal: '取消',
				title: ' 请阅读上述入市须知',
				esc: false
			});
			return false;
		}

		if ($("#balancePay").attr("checked") == "checked") {
			var bonusAmount = {$userData.freeztj};
			var paymentAmount = {$data.money};
			if (bonusAmount < paymentAmount) {
				art.dialog({
					lock: true,
					opacity: 0.3,
					icon: 'error',
					content: '您的钱包余额为: ￥' + fmoney({$userData.freeztj},
					2) + '<br>钱包余额不足，请充值后再进行支付！',
					ok: function() {},
					width: 300,
					cancel: false,
					okVal: '确定',
					cancelVal: '取消',
					title: '使用钱包余额付款',
					esc: false
				});
				return;
			}

			art.dialog({
				title: '温馨提示',
				content: '确认使用奖金余额支付?',
				width: 250,
				height: 40,
				okVal: '确定',
				cancelVal: '取消',
				ok: function() {
					$.post("{:U('Index/balancePay')}", {
						paymentId: {$data.id},
						type: '2',
						paymentAmount: {$data.money},
						bonusAmount: {$userData.freeztj},
						currentMemberId: {$userData.ue_id},
						count: {$data.money}/registerAmount
								},
								function(returnedData,status) 
								{
									//alert(returnedData.nr);
						          if (returnedData.sf == 0) {
							        var dialog = art.dialog({
							        content: '该订单已经支付成功！会员激活成功！',
							        ok: function() {
							        window.location.href = "{:U('Index/paylist')}";
							        },
							        width: 200,
							        cancel: false,
							        lock: true,
							        opacity: 0.3,
							        icon: 'succeed',
							        okVal: '确定',
							        cancelVal: '取消',
							        title: '钱包余额付款成功',
							        height: 20
							     });

						} else if (returnedData.sf == 5) {
							var dialog = art.dialog({
								content: returnedData.nr,
								ok: function() {
									window.location.href = "{:U('Index/paylist')}";
								},
								width: 200,
								cancel: false,
								lock: true,
								opacity: 0.3,
								icon: 'succeed',
								okVal: '确定',
								cancelVal: '取消',
								title: '钱包余额付款成功',
								height: 20
							});
						} else if (returnedData.sf == 1) {
							var dialog = art.dialog({
								content: '该订单已经支付过，不需要再次支付！',
								ok: function() {},
								width: 200,
								cancel: false,
								lock: true,
								opacity: 0.3,
								icon: 'error',
								okVal: '确定',
								cancelVal: '取消',
								title: '钱包余额付款失败',
								height: 20
							});
						} else if (returnedData == 2) {
							var dialog = art.dialog({
								content: '钱包余额不足，请使用支付网关付款或者充值后再进行支付！',
								ok: function() {},
								width: 200,
								cancel: false,
								lock: true,
								opacity: 0.3,
								icon: 'error',
								okVal: '确定',
								cancelVal: '取消',
								title: '钱包余额付款失败',
								height: 20
							});
						} else if (returnedData == 3) {
							var dialog = art.dialog({
								content: '支付失败,请重试！',
								ok: function() {},
								width: 200,
								cancel: false,
								lock: true,
								opacity: 0.3,
								icon: 'error',
								okVal: '确定',
								cancelVal: '取消',
								title: '付款失败',
								height: 20
							});
						}
					});
				},
				cancel: function() {}
			});
		} else {
			setTimeout(function() {
				art.dialog({
					title: '温馨提示',
					content: '确认是否完成支付操作?',
					width: 250,
					height: 40,
					cancelValue: '遇到问题',
					okValue: '完成支付',
					ok: function() {
						top.location.href = "/Home/Index/paylist/";
					}
				});
			},
			1000);

		}
	}

	function fmoney(s, n) {
		n = n > 0 && n <= 20 ? n: 2;
		s = parseFloat((s + "").replace(/[^\d\.-]/g, "")).toFixed(n) + "";
		var l = s.split(".")[0].split("").reverse(),
		r = s.split(".")[1];
		t = "";
		for (i = 0; i < l.length; i++) {
			t += l[i] + ((i + 1) % 3 == 0 && (i + 1) != l.length ? ",": "");
		}
		return t.split("").reverse().join("") + "." + r;
	}
	$.ajaxSetup({
		cache: false
	});
</script>
<include file='index:foot' />